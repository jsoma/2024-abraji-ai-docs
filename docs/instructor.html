<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Abraji 2024: AI for Investigating Documents - Extracting structured data with Instructor</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./using-pdfs.html" rel="next">
<link href="./slides.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="static/style.css">
<meta name="twitter:title" content="Abraji 2024: AI for Investigating Documents - Extracting structured data with Instructor">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@dangerscarf">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar docked nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Abraji 2024: AI for Investigating Documents</span>
    </a>
  </div>
        <div class="quarto-navbar-tools">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./instructor.html">Instructor (Python)</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lots of links</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./instructor.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Instructor (Python)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using-pdfs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparing PDFs</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Extracting structured data with Instructor</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>If you have a bunch of data in a messy format (user-input text, usually), an LLM is a great way to pull out the useful parts. <a href="https://python.useinstructor.com/">Instructor</a> can help you take that content and turn it into structured data!</p>
<p>Let’s start by <strong>installing Instructor</strong>. We’ll also install <a href="https://tqdm.github.io/">tqdm</a>, which allows for some nice progress bars.</p>
<div id="44555bbf-10e6-4211-9c52-0ac768e6a0c7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install <span class="op">--</span>quiet <span class="op">--</span>upgrade instructor tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
[notice] A new release of pip is available: 23.0.1 -&gt; 24.1.2
[notice] To update, run: pip install --upgrade pip
Note: you may need to restart the kernel to use updated packages.</code></pre>
</div>
</div>
<section id="instructor-in-a-single-use" class="level2">
<h2 class="anchored" data-anchor-id="instructor-in-a-single-use">Instructor in a single use</h2>
<p>First we’ll use Instructor on a single line of code. In this case, extracting structured data from an article.</p>
<p>Each article has a summary, a list of sources, a language and and a category. Each “source” has both a name and an optional title.</p>
<p><strong>You’ll need your own OpenAI API key</strong> to serve as your username and password when connecting Instructor to GPT. You can get yours <a href="https://platform.openai.com/account/api-keys">here</a>. Feel free to email me to borrow one of my API keys, you can find me at js4571@columbia.edu</p>
<div id="4fe63c4d-fac8-4128-9cb7-fb8bb21237c3" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> instructor</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, List</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing_extensions <span class="im">import</span> Literal</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person(BaseModel):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Person's name"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    title: Optional[<span class="bu">str</span>] <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Person's title, if available"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Article(BaseModel):</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    summary: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Brief, one-sentence summary (in English)"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    sources: List[Person] <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"People mentioned in the article"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    language_code: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Two-letter language code of original text"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    category: Literal[<span class="st">"politics"</span>, <span class="st">"sports"</span>, <span class="st">"international"</span>, <span class="st">"other"</span>]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add your own API key</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.from_openai(OpenAI(api_key<span class="op">=</span><span class="st">'sk-proj-XXXXXXXXXXXXXXXXXXXX'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The article we’ll be analyzing is below.</p>
<div id="ce593036" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>article <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">"Elections européennes : Emmanuel Macron dénonce « l'hypocrisie » du RN</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">Le chef de l'Etat a déploré mercredi depuis Bruxelles que les « peurs profitent aux réponses les plus simplistes » dans la campagne pour le scrutin du 9 juin, fustigeant ceux qui dénoncent l'Union européenne tout en engrangeant les « dividendes silencieux ».</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">Vous pouvez partager un article en cliquant sur les icônes de partage en haut à droite de celui-ci. </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">La reproduction totale ou partielle d'un article, sans l'autorisation écrite et préalable du Monde, est strictement interdite. </span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">Pour plus d'informations, consultez nos conditions générales de vente. </span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="st">Pour toute demande d'autorisation, contactez syndication@lemonde.fr. </span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="st">En tant qu'abonné, vous pouvez offrir jusqu'à cinq articles par mois à l'un de vos proches grâce à la fonctionnalité « Offrir un article ». </span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="st">https://www.lemonde.fr/elections-europeennes/article/2024/04/17/elections-europeennes-emmanuel-macron-denonce-l-hypocrisie-du-rn_6228404_1168667.html</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="st">Interrogé en marge de son déplacement à Bruxelles sur la campagne des élections européennes, Emmanuel Macron a déploré que les «&nbsp;peurs profitent aux réponses les plus simplistes&nbsp;», mercredi 17&nbsp;avril. Il a également fustigé «&nbsp;l'hypocrisie&nbsp;» de ceux qui dénoncent l'Union européenne mais en engrangent les «&nbsp;dividendes silencieux&nbsp;».</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="st">«&nbsp;Je pense qu'il y a beaucoup de peurs, d'inquiétudes dans le moment que nous vivons et que ces colères profitent toujours aux réponses les plus simplistes&nbsp;», a déclaré le chef de l'Etat français lors de son arrivée dans la capitale belge avant la tenue d'un sommet européen, au cours d'un bref échange avec la presse aux côtés de la tête de liste de son camp aux européennes, Valérie Heyer. «&nbsp;Il y a aujourd'hui une espèce d'hypocrisie du débat et j'espère qu'en rentrant dans les prochaines semaines dans celui-ci, cette hypocrisie sera levée&nbsp;», a ajouté M.&nbsp;Macron, visant en creux le Rassemblement national (RN), dont la liste est conduite par Jordan Bardella.</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="st">Il s'agissait de la première apparition publique du chef de l'Etat et de Mme&nbsp;Hayer depuis le début de la campagne, avant qu'ils n'assistent ensemble à une réunion du groupe Renew Europe.</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="st">Vous pouvez partager un article en cliquant sur les icônes de partage en haut à droite de celui-ci. </span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="st">La reproduction totale ou partielle d'un article, sans l'autorisation écrite et préalable du Monde, est strictement interdite. </span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="st">Pour plus d'informations, consultez nos conditions générales de vente. </span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="st">Pour toute demande d'autorisation, contactez syndication@lemonde.fr. </span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="st">En tant qu'abonné, vous pouvez offrir jusqu'à cinq articles par mois à l'un de vos proches grâce à la fonctionnalité « Offrir un article ». </span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="st">https://www.lemonde.fr/elections-europeennes/article/2024/04/17/elections-europeennes-emmanuel-macron-denonce-l-hypocrisie-du-rn_6228404_1168667.html</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="st">L'extrême droite ciblée par le camp présidentiel</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="st">La candidate du camp présidentiel peine pour l'instant à imprimer sa marque dans la campagne. La liste Renaissance reste largement distancée dans les sondages par celle du Rassemblement national (RN), qui ne cesse de creuser l'écart et caracole à plus de 30&nbsp;</span><span class="sc">% d</span><span class="st">'intentions de vote. Donnée autour de 16&nbsp;</span><span class="sc">% d</span><span class="st">'intentions, elle est également talonnée par celle du PS-Place publique, menée par Raphaël Glucksmann.</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="st">Le camp présidentiel est en outre suspendu à une entrée en campagne du chef de l'Etat, dont les contours n'ont pour l'heure pas été précisés, alors que le premier ministre, Gabriel Attal, reste pour l'heure discret en la matière. Ce dernier fait le pari que la campagne ne démarrera réellement que dans la dernière ligne droite, un mois avant le scrutin du 9&nbsp;juin, mais l'exécutif cible ces dernières semaines l'extrême droite, qu'il considère comme son principal adversaire dans le scrutin.</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="st">Vous pouvez partager un article en cliquant sur les icônes de partage en haut à droite de celui-ci. </span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="st">La reproduction totale ou partielle d'un article, sans l'autorisation écrite et préalable du Monde, est strictement interdite. </span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="st">Pour plus d'informations, consultez nos conditions générales de vente. </span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="st">Pour toute demande d'autorisation, contactez syndication@lemonde.fr. </span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="st">En tant qu'abonné, vous pouvez offrir jusqu'à cinq articles par mois à l'un de vos proches grâce à la fonctionnalité « Offrir un article ». </span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="st">https://www.lemonde.fr/elections-europeennes/article/2024/04/17/elections-europeennes-emmanuel-macron-denonce-l-hypocrisie-du-rn_6228404_1168667.html</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="st">Depuis Bruxelles, Emmanuel Macron a fait un premier pas dans l'offensive en vue du scrutin du 9&nbsp;juin, ciblant ainsi sans le nommer le RN, et ses contradictions sur la question européenne, l'économie ou encore la diplomatie. «&nbsp;Ceux qui parfois il y a cinq ans disaient “la solution c'est sortir de l'euro”, ceux qui ne votent même pas la politique agricole commune mais ensuite disent à la maison aux agriculteurs “je vous défends”, ceux qui systématiquement ont essayé d'affaiblir l'Europe en quelque sorte ont les dividendes silencieux de notre propre politique proeuropéenne&nbsp;», a asséné Emmanuel Macron.</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="st">«&nbsp;Ils expliquent, “nous, on va rendre notre pays plus fort”. Si leur politique avait été suivie depuis cinq ans, on ne serait pas là pour parler de la même façon de notre Europe&nbsp;!&nbsp;», a-t-il poursuivi, avant d'ajouter&nbsp;: «&nbsp;Ils auraient soigné [le Covid-19] à l'hydroxychloroquine, pris le vaccin russe, divisé l'Europe suite à l'agression russe. Ils n'auraient pris aucune sanction [contre la Russie], l'Ukraine aurait déjà été abandonnée. Et ils auraient abandonné aussi l'ambition européenne en matière de recherche et de technologie.&nbsp;»</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will send the article to GPT, along with the <code>Article</code> formatter. that describes what we want back.</p>
<div id="4233221d-f5b3-496a-94e6-ff531a7f4751" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>Article,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: article}],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result was saved as <code>result</code>, which we can look at nicely by printing out <code>result.model_dump()</code>. It’s kind of complicated – there are a lot of sources! – which is why we’re using pretty printing.</p>
<div id="01df3753-2939-4350-940c-f15e3b8ca240" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>pprint(result.model_dump())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'category': 'politics',
 'language_code': 'fr',
 'sources': [{'name': 'Emmanuel Macron', 'title': 'President of France'},
             {'name': 'Jordan Bardella',
              'title': 'Head of the RN list for the European elections'},
             {'name': 'Valérie Heyer',
              'title': "Head of Macron's camp list for the European elections"},
             {'name': 'Gabriel Attal', 'title': 'Prime Minister of France'},
             {'name': 'Raphaël Glucksmann',
              'title': 'Head of the PS-Place publique list for the European '
                       'elections'}],
 'summary': "Emmanuel Macron critiques the 'hypocrisy' of the National Rally "
            '(RN) during the European elections campaign.'}</code></pre>
</div>
</div>
</section>
<section id="instructor-with-a-pandas-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="instructor-with-a-pandas-dataframe">Instructor with a pandas dataframe</h2>
<p>You will often want to use Instructor not just with <em>one</em> element of data, but with <em>many</em>. Let’s try again with a spreadsheet of content!</p>
<p>Again, <strong>you’ll need your own OpenAI API key</strong> to serve as your username and password when connecting Instructor to GPT. You can get yours <a href="https://platform.openai.com/account/api-keys">here</a>. Feel free to email me to borrow one of my API keys, you can find me at js4571@columbia.edu</p>
<div id="7c141577-af20-4800-b8ed-2726c84b5ef4" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_colwidth <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"https://docs.google.com/spreadsheets/d/e/2PACX-1vQlfNIJOmGYG1vK1RkI5sa2R3_0fZohl7FIPwVN6HenlY-RZzzuIAiZ3E2GLITI6bANbYT7Wm1Lk_UA/pub?gid=228719919&amp;single=true&amp;output=csv"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">URL</th>
<th data-quarto-table-cell-role="th">content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>https://www.nytimes.com/2024/04/17/us/politics/senate-alejandro-mayorkas-impeachment-charge.html</td>
<td>Senate Dismisses Impeachment Charges Against Mayorkas Without a Trial\n\nDemocrats quickly swept aside the articles of impeachment accusing the homeland security secretary of refusing to enforce immigration laws and breach of public trust, calling them unconstitutional.\n\nThe Senate on Wednesday dismissed the impeachment case against Alejandro N. Mayorkas, the homeland security secretary, voting along party lines before his trial got underway to sweep aside two charges accusing him of faili...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>https://www.washingtonpost.com/national-security/2024/04/17/niger-air-force-whistleblower/</td>
<td>Defying Niger exit order leaves U.S. troops vulnerable, whistleblower says\n\nDeployed Americans are in limbo, unable to do their jobs or go home while State Department seeks to extend military presence, complaint contends\n\nA senior U.S. Air Force leader deployed in Niger is raising an alarm over the Biden administration’s reluctance to heed an eviction notice from the military junta that last year overthrew the West African nation’s democratically elected government.\n\nThe airman, in a p...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>https://www.washingtonpost.com/sports/2024/04/17/jake-irvin-nationals-dodgers-road-trip/</td>
<td>Jake Irvin delivers as Nationals beat Dodgers again to close road trip\n\nLOS ANGELES — It was only fitting that Jake Irvin’s start Wednesday afternoon at Dodger Stadium ended the way it did: with a high fastball in on the hands of Los Angeles catcher Will Smith.\n\nIt was the sixth pitch of the at-bat. The Washington Nationals right-hander had thrown five fastballs in a row. For his sixth pitch, he didn’t deviate from the plan: He fired a fastball by Smith, notching his sixth strikeout in t...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>https://www.lanacion.com.ar/economia/ante-inversores-en-washington-caputo-defendio-la-estrategia-fiscal-y-reafirmo-el-compromiso-para-nid17042024/</td>
<td>Ante inversores en Washington, Caputo defendió la estrategia fiscal y reafirmó el compromiso para levantar el cepo\n\nEl jefe del Palacio de Hacienda participó de un seminario organizado por el banco J.P. Morgan\n\nWASHINGTON.- El ministro de Economía, Luis Caputo, llegó al seminario del banco de inversión J.P. Morgan en el Park Hyatt hotel poco después de las tres de la tarde, hora local, un rato después de aterrizar en Washington, junto con el secretario de Finanzas, Pablo Quirno. El títul...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>https://www.lemonde.fr/elections-europeennes/article/2024/04/17/elections-europeennes-emmanuel-macron-denonce-l-hypocrisie-du-rn_6228404_1168667.html</td>
<td>Elections européennes : Emmanuel Macron dénonce « l’hypocrisie » du RN\n\nLe chef de l’Etat a déploré mercredi depuis Bruxelles que les « peurs profitent aux réponses les plus simplistes » dans la campagne pour le scrutin du 9 juin, fustigeant ceux qui dénoncent l’Union européenne tout en engrangeant les « dividendes silencieux ».\n\nVous pouvez partager un article en cliquant sur les icônes de partage en haut à droite de celui-ci. \nLa reproduction totale ou partielle d’un article, sans l’a...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Before we get started I’m going to turn on tqdm, which gives us a nice progress bar as we go through each row. If we didn’t have a progress bar we’d never know how much longer we had to wait!</p>
<div id="c4ea0035-b7b2-4eea-b9cc-69f00e4ca6c9" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>tqdm.pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>process</code> function takes the <code>content</code> column, then sends it to GPT to get a response. You can find a list of available models on <a href="https://platform.openai.com/docs/models">OpenAI’s website</a>, but <code>gpt-4o</code> is a good combination of quality and price.</p>
<div id="66b1986c" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process(row):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    article <span class="op">=</span> row[<span class="st">'content'</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        response_model<span class="op">=</span>Article,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: article}],</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the dictionary into a pandas series</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(result.model_dump())</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Run process for every row in the dataframe</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>ai_df <span class="op">=</span> df.progress_apply(process, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>ai_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 6/6 [00:54&lt;00:00,  9.04s/it]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">summary</th>
<th data-quarto-table-cell-role="th">sources</th>
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>The Senate dismissed impeachment charges against Homeland Security Secretary Alejandro N. Mayorkas before trial, ruling the charges unconstitutional, with votes largely along party lines.</td>
<td>[{'name': 'Alejandro N. Mayorkas', 'title': 'Homeland Security Secretary'}, {'name': 'Chuck Schumer', 'title': 'Senator, Majority Leader'}, {'name': 'Lisa Murkowski', 'title': 'Senator'}, {'name': 'Mitch McConnell', 'title': 'Senator, Minority Leader'}, {'name': 'Mike Lee', 'title': 'Senator'}, {'name': 'John Thune', 'title': 'Senator'}, {'name': 'Mia Ehrenberg', 'title': 'Spokeswoman for the Department of Homeland Security'}]</td>
<td>en</td>
<td>politics</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>A senior U.S. Air Force leader in Niger has filed a whistleblower complaint accusing U.S. embassy officials of suppressing intelligence to maintain the appearance of a good relationship with Niger's junta, leaving U.S. troops vulnerable and unable to do their jobs or go home.</td>
<td>[{'name': 'Kathleen FitzGibbon', 'title': 'Ambassador'}, {'name': 'Nora J. Nelson-Richter', 'title': 'Air Force Col. and Defense Attaché'}, {'name': 'Dusty Johnson', 'title': 'Rep. (R-S.D.)'}]</td>
<td>en</td>
<td>politics</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Jake Irvin's impressive performance leads Nationals to a 2-0 victory over the Dodgers, concluding their road trip with a series win.</td>
<td>[{'name': 'Jake Irvin', 'title': 'Washington Nationals right-hander'}, {'name': 'Luis García Jr.', 'title': 'second baseman'}, {'name': 'Dave Martinez', 'title': 'Manager'}]</td>
<td>en</td>
<td>sports</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Luis Caputo defendió la estrategia fiscal y reafirmó el compromiso para levantar el cepo ante inversores en Washington, destacando los avances económicos del gobierno de Javier Milei.</td>
<td>[{'name': 'Luis Caputo', 'title': 'Ministro de Economía'}, {'name': 'Pablo Quirno', 'title': 'Secretario de Finanzas'}, {'name': 'Nicolás Posse', 'title': 'Jefe de Gabinete'}, {'name': 'Pierre-Olivier Gourinchas', 'title': 'Economista jefe del FMI'}]</td>
<td>es</td>
<td>politics</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>French President Emmanuel Macron criticizes the National Rally's (RN) "hypocrisy" in the European elections campaign, denouncing their anti-EU stance while benefiting from EU policies.</td>
<td>[{'name': 'Emmanuel Macron', 'title': 'President of France'}, {'name': 'Jordan Bardella', 'title': 'Head of the National Rally's list in the European elections'}, {'name': 'Valérie Heyer', 'title': 'Head of Macron's camp list in the European elections'}, {'name': 'Gabriel Attal', 'title': 'Prime Minister of France'}, {'name': 'Raphaël Glucksmann', 'title': 'Head of the PS-Place publique list'}]</td>
<td>fr</td>
<td>politics</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Now we can combine the AI results with the original dataframe and save it to a CSV file.</p>
<div id="158dc80f" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> df.join(ai_df)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>merged.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">URL</th>
<th data-quarto-table-cell-role="th">content</th>
<th data-quarto-table-cell-role="th">summary</th>
<th data-quarto-table-cell-role="th">sources</th>
<th data-quarto-table-cell-role="th">language_code</th>
<th data-quarto-table-cell-role="th">category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>https://www.nytimes.com/2024/04/17/us/politics/senate-alejandro-mayorkas-impeachment-charge.html</td>
<td>Senate Dismisses Impeachment Charges Against Mayorkas Without a Trial\n\nDemocrats quickly swept...</td>
<td>The Senate dismissed impeachment charges against Homeland Security Secretary Alejandro N. Mayork...</td>
<td>[{'name': 'Alejandro N. Mayorkas', 'title': 'Homeland Security Secretary'}, {'name': 'Chuck Schu...</td>
<td>en</td>
<td>politics</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>https://www.washingtonpost.com/national-security/2024/04/17/niger-air-force-whistleblower/</td>
<td>Defying Niger exit order leaves U.S. troops vulnerable, whistleblower says\n\nDeployed Americans...</td>
<td>A senior U.S. Air Force leader in Niger has filed a whistleblower complaint accusing U.S. embass...</td>
<td>[{'name': 'Kathleen FitzGibbon', 'title': 'Ambassador'}, {'name': 'Nora J. Nelson-Richter', 'tit...</td>
<td>en</td>
<td>politics</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>https://www.washingtonpost.com/sports/2024/04/17/jake-irvin-nationals-dodgers-road-trip/</td>
<td>Jake Irvin delivers as Nationals beat Dodgers again to close road trip\n\nLOS ANGELES — It was o...</td>
<td>Jake Irvin's impressive performance leads Nationals to a 2-0 victory over the Dodgers, concludin...</td>
<td>[{'name': 'Jake Irvin', 'title': 'Washington Nationals right-hander'}, {'name': 'Luis García Jr....</td>
<td>en</td>
<td>sports</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>https://www.lanacion.com.ar/economia/ante-inversores-en-washington-caputo-defendio-la-estrategia...</td>
<td>Ante inversores en Washington, Caputo defendió la estrategia fiscal y reafirmó el compromiso par...</td>
<td>Luis Caputo defendió la estrategia fiscal y reafirmó el compromiso para levantar el cepo ante in...</td>
<td>[{'name': 'Luis Caputo', 'title': 'Ministro de Economía'}, {'name': 'Pablo Quirno', 'title': 'Se...</td>
<td>es</td>
<td>politics</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>https://www.lemonde.fr/elections-europeennes/article/2024/04/17/elections-europeennes-emmanuel-m...</td>
<td>Elections européennes : Emmanuel Macron dénonce « l’hypocrisie » du RN\n\nLe chef de l’Etat a dé...</td>
<td>French President Emmanuel Macron criticizes the National Rally's (RN) "hypocrisy" in the Europea...</td>
<td>[{'name': 'Emmanuel Macron', 'title': 'President of France'}, {'name': 'Jordan Bardella', 'title...</td>
<td>fr</td>
<td>politics</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Beautiful, right??</p>
<div id="bd01eb83" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>merged.to_csv(<span class="st">"completed.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="validating-responses-from-the-llm" class="level2">
<h2 class="anchored" data-anchor-id="validating-responses-from-the-llm">Validating responses from the LLM</h2>
<p>One fun part of Instructor is <strong>validating responses</strong>, to be able to do follow-up questions with GPT to make sure the responses are correct.</p>
<p>The approach below makes sure emails have an <code>@</code> symbol in them.</p>
<div id="9f3138ba-e340-49e5-b6b4-405b005bdd48" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> instructor</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, field_validator</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, List</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing_extensions <span class="im">import</span> Literal</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Comment(BaseModel):</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Submitter name"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    email: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Submitter email address"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    position: Literal[<span class="st">"for"</span>, <span class="st">"against"</span>, <span class="st">"neutral"</span>] <span class="op">=</span> Field(<span class="st">"Position on the regulation"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@field_validator</span>(<span class="st">"email"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validate_email(cls, value):</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value <span class="kw">and</span> <span class="st">'@'</span> <span class="kw">not</span> <span class="kw">in</span> value:</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Email missing @"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> value</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add your own API key</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.from_openai(OpenAI(api_key<span class="op">=</span><span class="st">'sk-proj-XXXXXXXXXXXXXXXXXXXX'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the example below, Mulberry is hiding his email address by using <code>(at)</code> and <code>(dot)</code>. While GPT will usually correctly translate it into <code>mulberry@catmail.com</code>, we can be <em>super certain</em> by demanding that all email addresses have an <code>@</code> in them.</p>
<div id="80f4143b-cbfd-45de-90bf-1003495f2c09" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>comment <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">My name is Mulberry Pepperstown and I think this regulation is awful!</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">You can respond to this at mulberry (at) catmail (dot) com</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>Comment,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: comment}],</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    max_retries<span class="op">=</span><span class="dv">3</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We set a maximum number of retries to allow a back-and-forth conversation with the LLM up to 3 times. And the final answer is… perfect!</p>
<div id="51aa6dab-3c0b-42c0-87e9-aefbdfbe933f" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>result.model_dump()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>{'name': 'Mulberry Pepperstown',
 'email': 'mulberry@catmail.com',
 'position': 'against'}</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./slides.html" class="pagination-link" aria-label="Slides">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Slides</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./using-pdfs.html" class="pagination-link" aria-label="Preparing PDFs">
        <span class="nav-page-text">Preparing PDFs</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Find me at <a href="mailto:js4571@columbia.com">js4571@columbia.com</a> or <a href="https://twitter.com/dangerscarf"><span class="citation" data-cites="dangerscarf">@dangerscarf</span></a></p>
</div>   
    <div class="nav-footer-center">
<p>©2024, Jonathan Soma</p>
<div class="toc-actions"><ul><li><a href="https://github.dev/jsoma/2024-abraji-ai-docs/blob/main/instructor.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/jsoma/2024-abraji-ai-docs/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jsoma">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dangerscarf">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:js4571@columbia.edu">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>